[{"name":"app.R","content":"# ==========================================================\n# app.R â€” SARS-CoV-2 qPCR Primer/Probe Mutation Heatmap + Mutational Burden + Wastewater Z-score\n# Prefetched CSV implementation for N1, N2, N200, E_Sarbeco\n# ==========================================================\n\nlibrary(shiny)\nlibrary(tidyverse)\nlibrary(lubridate)\nlibrary(DT)\nlibrary(cowplot)\nlibrary(patchwork)\n\n# --------------------------------------------------------------\n# Prefetched data location and working directory FOR LOCAL TESTING\n#setwd(\"/Users/tyson/SynologyDrive/_work/R-PROJECTS/wwpcrqc\")\n#data_dir <- \"data\"\n\n# --------------------------------------------------------------\n# Load prefetched data from GitHub raw using manifest.json\n# --------------------------------------------------------------\n\ngithub_base <- \"https://raw.githubusercontent.com/rnaguru/wwpcrqc/main/data\"\n\nmanifest_url <- paste0(github_base, \"/manifest.json\")\nmanifest <- jsonlite::fromJSON(manifest_url)\n\nload_remote_csv <- function(filename){\n    url <- paste0(github_base, \"/\", filename)\n    tryCatch(\n        readr::read_csv(url, show_col_types = FALSE),\n        error = function(e){\n            warning(paste(\"Could not load:\", url))\n            tibble(date=as.Date(character()), position=numeric(), count=numeric())\n        }\n    )\n}\n\nprefetched_data <- list(\n    N1    = load_remote_csv(manifest$prefetched_N1),\n    N2    = load_remote_csv(manifest$prefetched_N2),\n    N200  = load_remote_csv(manifest$prefetched_N200),\n    E_Sarbeco = load_remote_csv(manifest$prefetched_E_Sarbeco)\n)\n\ntotal_sequences <- load_remote_csv(manifest$total_sequences)\n\n\n\n\n# --------------------------------------------------------------\n# Primer/probe positions & wildtype bases + blocks\npositions_N1 <- c(28287:28306, 28309:28332, 28335:28358)\nwt_N1 <- c(\n    strsplit(\"GACCCCAAAATCAGCGAAAT\", \"\")[[1]],\n    strsplit(\"ACCCCGCATTACGTTTGGTGGACC\", \"\")[[1]],\n    strsplit(\"TCTGGTTACTGCCAGTTGAATCTG\", \"\")[[1]]\n)\nblocks_N1 <- c(rep(\"Forward\", length(28287:28306)),\n               rep(\"Probe\", length(28309:28332)),\n               rep(\"Reverse\", length(28335:28358)))\n\npositions_N2 <- c(29164:29183, 29188:29210, 29213:29230)\nwt_N2 <- c(\n    strsplit(\"TTACAAACATTGGCCGCAAA\", \"\")[[1]],\n    strsplit(\"ACAATTTGCCCCCAGCGCTTCAG\", \"\")[[1]],\n    strsplit(\"GCGCGACATTCCGAAGAA\", \"\")[[1]]\n)\nblocks_N2 <- c(rep(\"Forward\", length(29164:29183)),\n               rep(\"Probe\", length(29188:29210)),\n               rep(\"Reverse\", length(29213:29230)))\n\n# Placeholder for E_Sarbeco and N200\npositions_E <- c(26269:26294, 26332:26357, 26360:26381)\nblocks_E <- c(rep(\"Forward\", 26), rep(\"Probe\", 26), rep(\"Reverse\", 22)) # dummy\npositions_N200 <- c(28840:28861, 28891:28905, 28941:28960)\nblocks_N200 <- c(rep(\"Forward\", 22), rep(\"Probe\", 15), rep(\"Reverse\", 21)) # dummy\n\ndefault_assays <- list(\n    N1 = list(positions=positions_N1, wt=wt_N1, blocks=blocks_N1),\n    N2 = list(positions=positions_N2, wt=wt_N2, blocks=blocks_N2),\n    E_Sarbeco = list(positions=positions_E, blocks=blocks_E),\n    N200 = list(positions=positions_N200, blocks=blocks_N200)\n)\n\n# Precompute x_pos for heatmap\nprecompute_xpos <- function(positions, blocks){\n    block_offsets <- c(\"Forward\" = 0, \"Probe\" = 0.5, \"Reverse\" = 1)\n    xpos <- as.numeric(factor(positions)) + block_offsets[blocks]\n    return(xpos)\n}\n\ndefault_assays$N1$x_pos <- precompute_xpos(default_assays$N1$positions, default_assays$N1$blocks)\ndefault_assays$N2$x_pos <- precompute_xpos(default_assays$N2$positions, default_assays$N2$blocks)\ndefault_assays$E_Sarbeco$x_pos <- precompute_xpos(default_assays$E_Sarbeco$positions, default_assays$E_Sarbeco$blocks)\ndefault_assays$N200$x_pos <- precompute_xpos(default_assays$N200$positions, default_assays$N200$blocks)\n\n# --------------------------------------------------------------\n# Load prefetched data\nload_prefetched_data <- function(assay_name){\n    path <- file.path(data_dir, paste0(\"prefetched_\", assay_name, \".csv\"))\n    if(file.exists(path)){\n        read_csv(path, show_col_types = FALSE)\n    } else {\n        warning(paste(\"Prefetched file not found for\", assay_name))\n        tibble(date=as.Date(character()), position=numeric(), count=numeric())\n    }\n}\n\nassay_names <- names(default_assays)\nprefetched_data <- lapply(assay_names, function(nm) load_prefetched_data(nm))\nnames(prefetched_data) <- assay_names\n\ntotal_seq_path <- file.path(data_dir, \"prefetched_total_sequences.csv\")\ntotal_sequences <- if(file.exists(total_seq_path)){\n    read_csv(total_seq_path, show_col_types = FALSE)\n} else {\n    tibble(date=as.Date(character()), total=numeric())\n}\n\n# --------------------------------------------------------------\n# Determine global date range\nall_dates <- bind_rows(prefetched_data) %>% pull(date)\nall_dates <- all_dates[is.finite(all_dates) & !is.na(all_dates)]\nif(length(all_dates)==0){\n    global_min_date <- as.Date(\"2020-01-01\")\n    global_max_date <- Sys.Date()\n} else {\n    global_min_date <- min(all_dates)\n    global_max_date <- max(all_dates)\n}\n\n# --------------------------------------------------------------\n# Shiny UI\n# --------------------------------------------------------------\nui <- fluidPage(\n    titlePanel(\"SARS-CoV-2 qPCR Primer/Probe Mutation Heatmap + Mutational Burden\"),\n    \n    sidebarLayout(\n        sidebarPanel(\n            sliderInput(\"date_slider\", \"Date range\",\n                        min=global_min_date,\n                        max=global_max_date,\n                        value=c(global_min_date, global_max_date),\n                        timeFormat=\"%Y-%m-%d\"),\n            \n            selectInput(\"panelA_assay\", \"Panel A assay (heatmap)\",\n                        choices=names(default_assays), selected=\"N1\"),\n            selectInput(\"panelB_assay\", \"Panel B assay (heatmap)\",\n                        choices=names(default_assays), selected=\"N2\"),\n            \n            selectizeInput(\"burden_assays\",\n                           \"Assays included in Panel C (mutational burden)\",\n                           choices=names(default_assays),\n                           selected=c(\"N1\",\"N2\"),\n                           multiple=TRUE),\n            width=3\n        ),\n        \n        mainPanel(\n            plotOutput(\"heatmap_panelA\", height=\"300px\"),\n            plotOutput(\"heatmap_panelB\", height=\"300px\"),\n            plotOutput(\"mutational_burden_plot\", height=\"350px\"),\n            plotOutput(\"total_sequences_plot\", height=\"300px\"),\n            \n            tabsetPanel(\n                tabPanel(\"Table\", DTOutput(\"table\")),\n                tabPanel(\"Download\", downloadButton(\"download\",\"Download CSV\"))\n            )\n        )\n    )\n)\n\n# --------------------------------------------------------------\n# Shiny Server\n# --------------------------------------------------------------\nserver <- function(input, output, session){\n    \n    # --------------------------\n    # Reactive filtered data\n    # --------------------------\n    data_reactive <- reactive({\n        range <- input$date_slider\n        \n        df_list <- lapply(prefetched_data, function(df){\n            df %>% filter(date >= range[1], date <= range[2])\n        })\n        \n        # Add blocks and x_pos\n        df_list <- lapply(names(df_list), function(nm){\n            df <- df_list[[nm]]\n            df$block <- default_assays[[nm]]$blocks[match(df$position, default_assays[[nm]]$positions)]\n            df$x_pos <- default_assays[[nm]]$x_pos[match(df$position, default_assays[[nm]]$positions)]\n            df\n        })\n        names(df_list) <- names(prefetched_data)\n        \n        list(\n            assays = df_list,\n            total_seq = total_sequences %>% filter(date >= range[1], date <= range[2])\n        )\n    })\n    \n    # --------------------------\n    # Heatmap plotting function\n    # --------------------------\n    plot_heatmap_blocks <- function(df, assay_name, total_seq_df){\n        req(nrow(df)>0)\n        df_summary <- df %>%\n            group_by(position, date, block) %>%\n            summarise(count=sum(count), .groups=\"drop\") %>%\n            left_join(total_seq_df %>% rename(total_sequences=total), by=\"date\") %>%\n            mutate(fraction = count / pmax(total_sequences,1))\n        \n        x_all <- sort(unique(df_summary$position))\n        x_breaks <- x_all[seq(1,length(x_all), by=2)]\n        y_breaks <- sort(unique(df_summary$date))[seq(1,length(unique(df_summary$date)), by=13)]\n        \n        ggplot(df_summary, aes(x=position, y=date, fill=fraction)) +\n            geom_tile(color=\"grey92\") +\n            scale_fill_gradient2(low=\"white\", mid=\"#dda0dd\", high=\"maroon\",\n                                 midpoint=0.5, limits=c(0,1), na.value=\"black\") +\n            facet_grid(.~block, scales=\"free_x\", space=\"free_x\") +\n            scale_x_continuous(breaks=x_breaks, minor_breaks=x_all) +\n            scale_y_date(breaks=y_breaks, labels=function(d) format(d,\"%b %Y\"), expand=c(0,0)) +\n            labs(x=\"Nucleotide position\", y=\"Submission date\", fill=\"Fraction of Sequences\", title=assay_name) +\n            theme_minimal() +\n            theme(axis.text.x=element_text(angle=90, vjust=0.5, hjust=0.5),\n                  axis.text.y=element_text(size=10),\n                  panel.spacing=unit(0.5,\"lines\"),\n                  axis.ticks=element_blank())\n    }\n    \n    # --------------------------\n    # Heatmaps\n    # --------------------------\n    output$heatmap_panelA <- renderPlot({\n        df <- data_reactive()$assays[[input$panelA_assay]]\n        cowplot::ggdraw(plot_heatmap_blocks(df, input$panelA_assay, data_reactive()$total_seq)) +\n            cowplot::draw_plot_label(\"A\", x=0, y=1, hjust=0, vjust=1, size=14)\n    })\n    \n    output$heatmap_panelB <- renderPlot({\n        df <- data_reactive()$assays[[input$panelB_assay]]\n        cowplot::ggdraw(plot_heatmap_blocks(df, input$panelB_assay, data_reactive()$total_seq)) +\n            cowplot::draw_plot_label(\"B\", x=0, y=1, hjust=0, vjust=1, size=14)\n    })\n    \n    # --------------------------\n    # Mutational burden (Panel C)\n    # --------------------------\n    \n    output$mutational_burden_plot <- renderPlot({\n        \n        # Pull reactive data\n        assays <- data_reactive()$assays\n        total_seq <- data_reactive()$total_seq\n        \n        # Get user-selected assays\n        selected <- input$burden_assays\n        req(length(selected) > 0)  # Ensure at least one assay is selected\n        \n        # Safely bind only selected assays\n        df_all <- bind_rows(lapply(selected, function(a) {\n            if(!is.null(assays[[a]]) && nrow(assays[[a]]) > 0) {\n                assays[[a]] %>% mutate(locus = a)\n            } else {\n                # Empty tibble for missing data\n                tibble(\n                    date = as.Date(character()),\n                    position = numeric(),\n                    count = numeric(),\n                    block = character(),\n                    x_pos = numeric(),\n                    locus = a\n                )\n            }\n        }))\n        \n        # Stop if no data at all\n        req(nrow(df_all) > 0)\n        \n        # Compute burden per date and locus\n        df_all <- df_all %>%\n            left_join(total_seq %>% rename(total_sequences = total), by = \"date\") %>%\n            mutate(burden = count / pmax(total_sequences, 1)) %>%\n            group_by(date, locus) %>%\n            summarise(mean_burden = sum(burden), .groups = \"drop\") %>%\n            arrange(date)\n        \n        # Prepare rectangular form for stacked area plot\n        df_all <- df_all %>%\n            tidyr::pivot_wider(\n                names_from = locus,\n                values_from = mean_burden,\n                values_fill = 0\n            ) %>%\n            tidyr::pivot_longer(\n                cols = all_of(selected),\n                names_to = \"locus\",\n                values_to = \"mean_burden\"\n            )\n        \n        # Identify low-sequence weeks\n        low_seq_df <- total_seq %>%\n            arrange(date) %>%\n            mutate(low_flag = total <= 50,\n                   group = cumsum(c(TRUE, diff(low_flag) != 0)))\n        \n        low_seq_ranges <- low_seq_df %>%\n            filter(low_flag) %>%\n            group_by(group) %>%\n            summarise(xmin = min(date)-3, xmax = max(date)+3, .groups=\"drop\")\n        \n        # Define colors for selected assays\n        all_colors <- c(\n            \"N1\" = \"firebrick\",\n            \"N2\" = \"steelblue\",\n            \"N200\" = \"forestgreen\",\n            \"E_Sarbeco\" = \"goldenrod\"\n        )\n        assay_colors <- all_colors[selected]\n        \n        # Stacked area plot\n        p_burden <- ggplot(df_all, aes(x = date, y = mean_burden, fill = locus)) +\n            geom_rect(\n                data = low_seq_ranges,\n                aes(xmin = xmin, xmax = xmax, ymin = 0, ymax = Inf),\n                inherit.aes = FALSE,\n                fill = \"darkorange\",\n                alpha = 0.5\n            ) +\n            geom_area(position = \"stack\", color = \"black\", linewidth = 0.2, alpha = 0.8) +\n            scale_fill_manual(values = assay_colors) +\n            labs(\n                title = \"Weekly Weighted Mutational Burden (stacked by assay)\",\n                y = \"Weighted Mutational Burden\",\n                x = NULL,\n                fill = \"Assay\"\n            ) +\n            theme_minimal(base_size = 14) +\n            theme(legend.position = \"top\")\n        \n        # Add plot label\n        cowplot::ggdraw(p_burden) +\n            cowplot::draw_plot_label(\"C\", x = 0, y = 1, hjust = 0, vjust = 1, size = 14)\n    })\n    \n    \n    \n    # --------------------------\n    # Total sequences (Panel D)\n    # --------------------------\n    output$total_sequences_plot <- renderPlot({\n        df <- data_reactive()$total_seq\n        req(df)\n        y_min <- min(df$total[df$total>0])*0.9\n        y_max <- max(df$total)*1.1\n        \n        p <- ggplot(df, aes(x=date, y=total)) +\n            geom_line(color=\"darkgreen\") +\n            geom_point(color=\"darkgreen\") +\n            scale_y_log10() +\n            labs(title=\"Weekly count of submitted sequences\", x=\"Week\", y=\"Total Sequences (log10)\") +\n            theme_minimal()\n        \n        cowplot::ggdraw(p) + cowplot::draw_plot_label(\"D\", x=0, y=1, hjust=0, vjust=1, size=14)\n    })\n    \n    # --------------------------\n    # Table + download\n    # --------------------------\n    output$table <- renderDT({\n        df_all <- bind_rows(\n            lapply(names(data_reactive()$assays), function(nm){\n                data_reactive()$assays[[nm]] %>% mutate(assay=nm)\n            })\n        ) %>% left_join(data_reactive()$total_seq %>% rename(total_sequences=total), by=\"date\")\n        datatable(df_all, options=list(pageLength=20))\n    })\n    \n    output$download <- downloadHandler(\n        filename=function(){paste0(\"mut_counts_\", Sys.Date(), \".csv\")},\n        content=function(file){\n            df_all <- bind_rows(\n                lapply(names(data_reactive()$assays), function(nm){\n                    data_reactive()$assays[[nm]] %>% mutate(assay=nm)\n                })\n            ) %>% left_join(data_reactive()$total_seq %>% rename(total_sequences=total), by=\"date\")\n            write_csv(df_all, file)\n        }\n    )\n}\n\n# --------------------------------------------------------------\nshinyApp(ui, server)\n","type":"text"}]
